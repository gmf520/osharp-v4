# osharp 权限系统分析

标签（空格分隔）： osharp 权限

---

## 一、身份认证(Identity)
### 1. 基本元素
 1. 用户(User)：系统功能执行者，表示一个自然人，用户应该是纯粹的，只拥有用户的基本属性，其他附加属性都应通过外部赋予才能获得
 2. 角色(Role)：权限的载体，将权限赋予用户，用户拥有某个角色，就拥有该角色的权限
 3. 用户-角色 映射(UserRoleMap)：将角色指派给用户，表示用户拥有该角色的权限
 4. 用户摘要标识(UserClaim)：摘要标识认证的信息载体
### 2. 身份认证流程
 1. 用户登录时，初始化用户拥有的角色集合信息
 2. 根据角色判断用户身份时，看用户是否拥有相应的角色

## 二、权限安全(Security)
### 1. 基本元素

 1. 功能项(Function)：系统的每个功能点，由系统初始化时反射类库自动生成，MVC/WebApi中是Controller中的每个Action，SignalR中是Hub中的每个public功能。Function是功能权限判断的最终落点，即某User是否有执行某Function的权限
 2. 实体数据(EntityInfo)：系统的每个实体的数据信息，由系统初始化时反射类库自动生成，所有继承`OSharp.Core.Data.IEntity`接口的类型，都认为是实体类型，EntityInfo既是数据日志的控制点，也将是数据权限判断的最终落点，即某User是否有查询某EntityInfo表示的实体的权限
 3. 模块(Module)：系统结成的模块，由一个或多个功能有机结合组成，模块由根到枝自成树形结构，一个父模块可包含一或多个子模块。**Module是授权的单元最小单元，子模块自动拥有父模块的功能**。进行功能权限判断时，将分析出当前模块及其父模块的所有Function，再进行功能权限的判断。模块信息与下列几个实体有映射关系：
    *  Module：模块与本身自成树形结构，一个父模块可包含一个或多个子模块，子模块自动拥有父模块的功能。当将一个模块赋予指定角色时，该角色自动拥有当前模块及所有父级模块的权限。
    *  Function：模块与功能为多对多关系，一个模块可拥有多个功能项，一个功能项也可被指派给多个模块。功能项之间依靠模块的树形结构，形成相关关联的层级关系。
    *  Role：模块与角色为多对多关系，一个模块可被分配给多个角色，一个角色也可拥有多个模块，获取角色的功能项集合时，将获取角色拥有的模块及其父模块的所有功能信息，常规的权限分配，都应通过角色-模块的指派来赋予。
    *  User：模块与用户为多对多关系，主要用于解决一些特权的问题，一个模块可被分配给多个用户，一个用户也可拥有多个模块，获取用户功能集合时，除了用户拥有的角色集合对应的模块的功能信息，还要加上用户对应模块的功能信息。
    
### 2. 功能权限与数据权限
 6. 功能权限：用户是否具有执行某个功能的权限
    *  功能权限判断流程：
        * 系统初始化时，针对每个角色，通过角色对应的模块，初始化角色拥有的所有功能点集合
        * 用户登录时，初始化用户拥有的角色集合，以及用户对应的模块，初始化用户拥有的功能点集合
        * 用户执行一个功能点时，由功能点查询出所需要的角色集合，判断用户是否拥有需要的角色。如否，则继续判断当前功能点是否在用户拥有的功能点集合中，如在，对允许执行，否则拒绝
 7. 数据权限：用户是否具有查询某个数据的权限